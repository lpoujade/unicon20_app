import 'package:path/path.dart';
import 'package:sqflite/sqflite.dart';
import 'dart:developer';

const db_name = 'unicon_db.db';
const db_version = 1;

const init_sql = [
  'create table article ( id integer unique, title text, content text, important integer default 0, date integer not null, read integer default 0)',
  'create table events ( uid text unique not null, title text not null, start integer not null, end integer not null, location text not null, type text not null, description text, summary text)'
];

/// Open connection to database  
/// Also register callback for db creation/migration/configuration
init_database() async {
  var db_path = await getDatabasesPath();
  return openDatabase(join(db_path, db_name),
      version: db_version, onCreate: (Database db, int version) async {
    var batch = db.batch();
    init_sql.forEach((script) => batch.execute(script));
    await batch.commit();
  }, onConfigure: (Database db) async {
    await db.execute("pragma foreign_keys = ON");
  });
}

/// Read date of the most recent article in local database,
/// if any
Future<DateTime?> get_last_sync_date(db) async {
  var sql = 'select date from article order by date desc limit 1';
  final result = await db.rawQuery(sql);
  return (result.length == 1)
      ? DateTime.fromMillisecondsSinceEpoch((result.first)['date'])
      : null;
}
